name: Build and Package for ArchLinux

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # ---------- 1. 初始化 ----------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
          cache: true

      - name: Initialize Go Modules
        run: |
          if [ ! -f go.mod ]; then
            go mod init github.com/Duter2016/hiwifi-ssh-launcher
          fi
          go mod tidy

      # ---------- 2. 构建二进制 ----------
      - name: Build Binary
        run: |
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -ldflags="-s -w" -o hiwifi-ssh-launcher .
          strip hiwifi-ssh-launcher

      # ---------- 3. 安装打包工具 ----------
      - name: Install Packaging Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            binutils \
            fakeroot \
            file \
            libarchive-tools \
            python3 \
            python3-pip
          
          # 安装可靠的精简版makepkg
          sudo pip install archlinux-pkgbuild-tools
          sudo curl -L https://gist.githubusercontent.com/Duter2016/$(curl -s https://gist.github.com/Duter2016 | grep -oP 'data-clipboard-text="\K[0-9a-f]+(?=")' | head -1)/raw -o /usr/bin/makepkg
          sudo chmod +x /usr/bin/makepkg

      # ---------- 4. 创建打包文件 ----------
      - name: Prepare Package
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF" ] && VERSION="0.0.1"
          
          cat <<EOF > PKGBUILD
          pkgname=hiwifi-ssh-launcher
          pkgver=$VERSION
          pkgrel=1
          pkgdesc="SSH Launcher for HiWiFi"
          arch=('x86_64')
          license=('MIT')
          source=("\$pkgname-\$pkgver.tar.gz")
          sha256sums=('SKIP')

          build() {
            cd "\$pkgname-\$pkgver"
            go build -ldflags="-s -w" -o \$pkgname .
          }

          package() {
            install -Dm755 "\$srcdir/\$pkgname-\$pkgver/\$pkgname" "\$pkgdir/usr/bin/\$pkgname"
          }
          EOF
          
          # 创建伪源文件
          mkdir -p "hiwifi-ssh-launcher-$VERSION"
          cp -r * "hiwifi-ssh-launcher-$VERSION"/ || true
          tar -czf "hiwifi-ssh-launcher-$VERSION.tar.gz" "hiwifi-ssh-launcher-$VERSION"

      # ---------- 5. 构建软件包 ----------
      - name: Build Package
        run: |
          # 添加必要的目录结构
          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg
          
          # 构建软件包
          makepkg -s --noconfirm SKIPCHECKSUMS SKIPPGPCHECK

      # ---------- 6. 上传产物 ----------
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-assets
          path: |
            hiwifi-ssh-launcher
            *.pkg.tar.zst
